#!/bin/bash

# ะะฟัะตะดะตะปัะตะผ ัะฒะตัะฐ ัะตะบััะฐ
WHITE="\033[1;37m"
RESET="\033[0m"
GREEN="\033[1;32m"
CYAN="\033[1;36m"
YELLOW="\033[1;33m"
BLUE="\033[1;34m"
RED="\033[1;31m"
MAGENTA="\033[1;35m"

# ะะพะณะพัะธะฟ
logo() {
    echo -e "  ##  ###  #######  ######   #######  #######  #######  ######   #######  ##  ##   #######  ###### "
    echo -e "  ### ###  ##   ##  ##  ##   ##       ##         ###    ##  ##     ###    ##  ##   ##       ##  ## "
    echo -e "  #######  ##   ##  ##  ##   ##       #######    ###    ##  ##     ###    ## ##    ##       ##  ## "
    echo -e "  ## ####  ##  ###  ### ###  #######       ##    ###    #######    ###    #######  #######  ####### "
    echo -e "  ##  ###  ##  ###  ### ###  ###      ###  ##    ###    ### ###    ###    ##  ###  ###      ### ### "
    echo -e "  ##  ###  ##  ###  ### ###  # #      ###  ##    ###    ### ###    ###    ##  ###  # #      ### ### "
    echo -e "  ##  ###  #######  #######  #######  #######    ###    ### ###  #######  ##  ###  #######  ### ### ${RESET}"
}

# ะคัะฝะบัะธั ัััะฐะฝะพะฒะบะธ ะฝะพะดั
install_node() {
    echo -e "${CYAN}ะะฐัะธะฝะฐะตััั ัััะฐะฝะพะฒะบะฐ ะฝะพะดั... ๐ฑ${RESET}"

    # ะะฑะฝะพะฒะปะตะฝะธะต ัะธััะตะผั ะธ ัััะฐะฝะพะฒะบะฐ ะฝะตะพะฑัะพะดะธะผัั ะฟะฐะบะตัะพะฒ
    sudo apt update && sudo apt install -y curl git make jq build-essential gcc unzip wget lz4 aria2 tmux

    # ะฃััะฐะฝะพะฒะบะฐ Dria Launcher (ะตัะปะธ ะตัั ะฝะต ัััะฐะฝะพะฒะปะตะฝ)
    if [ ! -f "/usr/local/bin/dria-launcher" ]; then
        echo -e "${YELLOW}ะกะบะฐัะธะฒะฐะฝะธะต ะธ ัััะฐะฝะพะฒะบะฐ Dria Launcher... ๐${RESET}"
        curl -fsSL https://dria.co/launcher | bash
    else
        echo -e "${GREEN}Dria Launcher ัะถะต ัััะฐะฝะพะฒะปะตะฝ. โ${RESET}"
    fi

    # ะฃััะฐะฝะพะฒะบะฐ Ollama (ะตัะปะธ ะตัั ะฝะต ัััะฐะฝะพะฒะปะตะฝ)
    if [ ! -f "/usr/local/bin/ollama" ]; then
        echo -e "${YELLOW}ะกะบะฐัะธะฒะฐะฝะธะต ะธ ัััะฐะฝะพะฒะบะฐ Ollama... ๐ป${RESET}"
        curl -fsSL https://ollama.com/install.sh | sh
    else
        echo -e "${GREEN}Ollama ัะถะต ัััะฐะฝะพะฒะปะตะฝ. โ${RESET}"
    fi

    # ะะฐะฟััะบ tmux-ัะตััะธะธ ั ะบะพะผะฐะฝะดะพะน ะทะฐะฟััะบะฐ ะฝะพะดั
    echo -e "${CYAN}ะะฐะฟััะบ tmux-ัะตััะธะธ ะดะปั ััะฐััะฐ ะฝะพะดั... ๐ฅ๏ธ${RESET}"

    # ะัะพะฒะตัะบะฐ, ัััะตััะฒัะตั ะปะธ ัะตััะธั tmux ั ะธะผะตะฝะตะผ 'dria_node'
    tmux has-session -t dria_node 2>/dev/null

    if [ $? != 0 ]; then
        # ะัะปะธ ะฝะต ัััะตััะฒัะตั โ ัะพะทะดะฐัะผ
        tmux new-session -d -s dria_node
        tmux send-keys -t dria_node 'dkn-compute-launcher start' C-m
        echo -e "${GREEN}ะะพะดะฐ ััะฟะตัะฝะพ ะทะฐะฟััะตะฝะฐ ะฒ ะฝะพะฒะพะน tmux-ัะตััะธะธ. ๐${RESET}"
    else
        # ะัะปะธ ัะถะต ะตััั โ ะพัะฟัะฐะฒะปัะตะผ ะบะพะผะฐะฝะดั ะฒ ะฝะตั
        tmux send-keys -t dria_node 'dkn-compute-launcher start' C-m
        echo -e "${CYAN}Tmux-ัะตััะธั 'dria_node' ัะถะต ัััะตััะฒัะตั. ะะพะผะฐะฝะดะฐ ะพัะฟัะฐะฒะปะตะฝะฐ. ๐${RESET}"
    fi

    # ะัะธัะพะตะดะธะฝะตะฝะธะต ะบ tmux-ัะตััะธะธ
    tmux attach -t dria_node

    read -p "ะะฐะถะผะธัะต Enter, ััะพะฑั ะฒะตัะฝััััั ะฒ ะผะตะฝั..." dummy
    show_menu
}

# ะัะพะฒะตัะบะฐ $DRIA ะฑะฐะปะปะพะฒ
check_points() {
    echo -e "${CYAN}ะัะพะฒะตัะบะฐ ะฑะฐะปะฐะฝัะฐ $DRIA... ๐ฐ${RESET}"
    dkn-compute-launcher points
    read -p "ะะฐะถะผะธัะต Enter, ััะพะฑั ะฒะตัะฝััััั ะฒ ะผะตะฝั..." dummy
    show_menu
}

# ะััะฝะพะต ะพะฑะฝะพะฒะปะตะฝะธะต
update_manually() {
    echo -e "${YELLOW}ะะฐัะธะฝะฐะตััั ัััะฝะพะต ะพะฑะฝะพะฒะปะตะฝะธะต... ๐${RESET}"
    dkn-compute-launcher update
    read -p "ะะฐะถะผะธัะต Enter, ััะพะฑั ะฒะตัะฝััััั ะฒ ะผะตะฝั..." dummy
    show_menu
}

# ะฃะดะฐะปะตะฝะธะต ะฝะพะดั
uninstall_node() {
    echo -e "${RED}ะั ัะฒะตัะตะฝั, ััะพ ัะพัะธัะต ัะดะฐะปะธัั ะฝะพะดั? ะญัะพ ะดะตะนััะฒะธะต ะฝะตะพะฑัะฐัะธะผะพ! ๐๏ธ${RESET}"
    read -p "ะะฒะตะดะธัะต 'yes' ะดะปั ะฟะพะดัะฒะตัะถะดะตะฝะธั: " confirm
    if [ "$confirm" != "yes" ]; then
        echo -e "${YELLOW}ะฃะดะฐะปะตะฝะธะต ะพัะผะตะฝะตะฝะพ. ๐ซ${RESET}"
        return
    fi

    # ะััะฐะฝะพะฒะบะฐ ะฝะพะดั, ะตัะปะธ ะพะฝะฐ ะทะฐะฟััะตะฝะฐ
    tmux has-session -t dria_node 2>/dev/null
    if [ $? == 0 ]; then
        echo -e "${CYAN}ะััะฐะฝะพะฒะบะฐ ะฝะพะดั ะฟะตัะตะด ัะดะฐะปะตะฝะธะตะผ... โน๏ธ${RESET}"
        tmux send-keys -t dria_node 'exit' C-m
        tmux kill-session -t dria_node
        echo -e "${GREEN}ะะพะดะฐ ััะฟะตัะฝะพ ะพััะฐะฝะพะฒะปะตะฝะฐ. ๐${RESET}"
    else
        echo -e "${YELLOW}ะะบัะธะฒะฝะฐั ัะตััะธั ะฝะพะดั ะฝะต ะฝะฐะนะดะตะฝะฐ. ะัะพะดะพะปะถะฐะตะผ ัะดะฐะปะตะฝะธะต. โก${RESET}"
    fi

    # ะฃะดะฐะปะตะฝะธะต ะฝะพะดั
    echo -e "${RED}ะฃะดะฐะปะตะฝะธะต ะฝะพะดั... ๐๏ธ${RESET}"
    dkn-compute-launcher uninstall

    # ะัะธััะบะฐ ะพััะฐะฒัะธััั ัะฐะนะปะพะฒ
    echo -e "${CYAN}ะัะธััะบะฐ ะพััะฐัะพัะฝัั ัะฐะนะปะพะฒ... ๐งน${RESET}"
    sudo rm -rf /usr/local/bin/dria-launcher
    sudo rm -rf /usr/local/bin/ollama
    sudo rm -rf .dria

    echo -e "${GREEN}ะะพะดะฐ ััะฟะตัะฝะพ ัะดะฐะปะตะฝะฐ ะธ ัะธััะตะผะฐ ะพัะธัะตะฝะฐ. ๐${RESET}"
    read -p "ะะฐะถะผะธัะต Enter, ััะพะฑั ะฒะตัะฝััััั ะฒ ะผะตะฝั..." dummy
    show_menu
}

# ะัะพัะผะพัั ะปะพะณะพะฒ
view_logs() {
    echo -e "${BLUE}ะะพะดะบะปััะตะฝะธะต ะบ tmux-ัะตััะธะธ ะดะปั ะฟัะพัะผะพััะฐ ะปะพะณะพะฒ... ๐${RESET}"
    tmux attach -t dria_node
    read -p "ะะฐะถะผะธัะต Enter, ััะพะฑั ะฒะตัะฝััััั ะฒ ะผะตะฝั..." dummy
    show_menu
}

# ะะปะฐะฒะฝะพะต ะผะตะฝั
show_menu() {
    clear
    logo  # ะะพะณะพัะธะฟ

    # ะะตะฝั
    echo -e "\n${WHITE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${RESET}"
    echo -e "${WHITE}โ        ะะะะฎ ะฃะะะะะะะะะฏ        โ${RESET}"
    echo -e "${WHITE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${RESET}\n"

    echo -e "${MAGENTA}=====================================${RESET}"
    echo "ะัะฑะตัะธัะต ะดะตะนััะฒะธะต:"
    echo -e "${YELLOW}1. ะฃััะฐะฝะพะฒะธัั ะฝะพะดั ๐ฑ${RESET}"
    echo -e "${GREEN}2. ะัะพะฒะตัะธัั $DRIA ะฑะฐะปะปั ๐ฐ${RESET}"
    echo -e "${CYAN}3. ะะฑะฝะพะฒะธัั ะฒัััะฝัั ๐${RESET}"
    echo -e "${RED}4. ะฃะดะฐะปะธัั ะฝะพะดั ๐๏ธ${RESET}"
    echo -e "${BLUE}5. ะะพัะผะพััะตัั ะปะพะณะธ ๐${RESET}"
    echo -e "${MAGENTA}6. ะััะพะด ๐ช${RESET}"
    echo -e "${MAGENTA}=====================================${RESET}"
    read -p "ะัะฑะตัะธัะต ะฟัะฝะบั [1-6]: " choice
    case $choice in
        1) install_node ;;
        2) check_points ;;
        3) update_manually ;;
        4) uninstall_node ;;
        5) view_logs ;;
        6) exit 0 ;;
        *) echo -e "${RED}ะะตะฒะตัะฝัะน ะฟัะฝะบั, ะฟะพะฟัะพะฑัะนัะต ัะฝะพะฒะฐ. โ${RESET}"; sleep 2; show_menu ;;
    esac
}

# ะะฐะฟััะบ ั ะณะปะฐะฒะฝะพะณะพ ะผะตะฝั
show_menu
